from __future__ import division

import sys
import cv
import cv2
import numpy as np
sys.path.append('/home/ubuntu/caffe/python/')
import caffe
import time

def readClassNames(filename="synset_words.txt"):
	classNames=[]	
	with open(filename, "r") as ins:
    		for line in ins:
			classNames.append(line[10:-1])
		return classNames

def main():
	modelTxt = "bvlc_googlenet.prototxt"
	modelBin = "bvlc_googlenet.caffemodel"
	imageFile = "watch.png" #"space_shuttle.jpg"
	
	caffe.set_mode_gpu()
	net = caffe.Classifier(modelTxt, modelBin,
	       mean=np.load('./ilsvrc_2012_mean.npy').mean(1).mean(1),
               raw_scale=255,
               image_dims=(244, 244)) #channel_swap=(2,1,0) ?
	
	start=time.time()
	img=caffe.io.load_image(imageFile)
	img = cv2.resize(img, (244,244))
	
	prediction = net.predict([img])
	print(prediction[0][712])
	classes=readClassNames()
	bestpreds=prediction[0].argsort()[-5:][::-1] # top-5 predictions
	print("--- TOP 5 PREDICTIONS ON "+imageFile+" ---")
	j=1
	for i in bestpreds:
		print str(j)+" - "+str(readClassNames()[i])
		j+=1
	stop=time.time()
	print("Execution time: "+str(stop-start)+" secs")

main()
